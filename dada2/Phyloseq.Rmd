---
title: "Phyloseq"
author: "Reimon Fernandez"
date: "2024-04-18"
output: pdf_document
---
###Start of phyloseq

```{r}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("phyloseq")
```

#Load packages

```{r}
library(phyloseq)
library(ggplot2)
```

```{r}
library(dplyr)
library(BiMiCo)
```

```{r}
load("RData/taxa.RData")
load("RData/seqtab.nochim.RData")
```

#import data
```{r}
metadata=read.csv("metadata.csv",header=TRUE,row.names = 1)
```

#create phyloseq object
```{r}
physeq=phyloseq(otu_table(seqtab.nochim,taxa_are_rows=FALSE),
                sample_data(metadata),
                tax_table(taxa))
physeq
```
#remove the sequence itself and relace with asv 
```{r}
dna=Biostrings::DNAStringSet(taxa_names(physeq))
names(dna)=taxa_names(physeq)
physeq=merge_phyloseq(physeq,dna)
taxa_names(physeq)=paste0("ASV",seq(ntaxa(physeq)))
physeq
```
#remove mitochondria and chloroplast matches. remove all non bacterial sequences
```{r}
physeq=physeq%>%subset_taxa(Family!="Mitochondria" | is.na(Family) & Order!="Chloroplast" | is.na(Order))
physeq
```
#removes all non bacterial sequiences
```{r}
physeq=rm_nonbac(physeq)
physeq
```

#save physeq objects to load later
```{r}
save(physeq,file="RData/physeq.RData")
```


```{r}
load("RData/physeq.RData")
```

#plot bar graph based on phylum
```{r}
plot_bar(physeq,fill="Phylum") + geom_bar(aes(color=Phylum,fill=Phylum),stat="identity",position="fill")
```

#create a barplot of relative abundance 
```{r}
#convert to relative abundance
physeq_relabund=transform_sample_counts(physeq,function(x)x/sum(x))

#barplot
plot_bar(physeq_relabund,fill="Phylum") + geom_bar(aes(color=Phylum,fill=Phylum),stat="identity",position="fill")+facet_wrap(~body.site,scales="free")
```
#plot alpha diversity based on body.site (how diverise is particular sample)
```{r}
plot_richness(physeq,x="body.site",color="subject",measures=c("Observed","Simpson","Shannon"))
```
#alpha diversity based on reported antibiotic usage
```{r}
plot_richness(physeq,x="reported.antibiotic.usage",color="body.site",measures=c("Observed","Simpson","Shannon"))
```
#plot alpha diversity by subject
```{r}
plot_richness(physeq,x="subject",color="body.site",measures=c("Observed","Simpson","Shannon"))
```
#test for normality
```{r}
alpha=estimate_richness(physeq,measures=c("Observed","Simpson","Shannon"))
```
#shapiro-wilk: null = the data is normally distributed
```{r}
observed=shapiro.test(alpha$Observed)
shannon=shapiro.test(alpha$Shannon)
simpson=shapiro.test(alpha$Simpson)
```

#print
```{r}
print(observed)
print(shannon)
print(simpson)
```
#create a data frame for statsitical analyses
```{r}
#extract sample information from the physeq object
samples=sample_data(physeq)


#if samples is a phyloseq sample_data object, convert it to a data frame
if (class(samples)=="sample_data") {samples=data.frame(sample_data(samples))
}

#add a column to alpha with sample names
alpha$sample=rownames(alpha)

#merge alpha diversity data and sample data
alpha=merge(alpha,samples,by="sample")
```


#perform statistics based on subject
```{r}
#perform t/wilcox tests for each biodiversity index; t-test only appropriate when normal distribution

test_observed=wilcox.test(Observed~subject,data=alpha)
test_simpson=wilcox.test(Simpson~subject,data=alpha)
test_shannon=t.test(Shannon~subject,data=alpha)

#Printing the results
print(test_observed)
print(test_simpson)
print(test_shannon)
```
#perform statistics based on reported.antibiotic.usage
```{r}
#perform t/wilcox tests for each biodiversity index; t-test only appropriate when normal distribution

test_observed=wilcox.test(Observed~reported.antibiotic.usage,data=alpha)
test_simpson=wilcox.test(Simpson~reported.antibiotic.usage,data=alpha)
test_shannon=t.test(Shannon~reported.antibiotic.usage,data=alpha)

#Printing the results
print(test_observed)
print(test_simpson)
print(test_shannon)
```

#test for body site
```{r}
kruskal.test(Simpson~body.site,data=alpha)
pairwise.wilcox.test(alpha$Simpson,alpha$body.site,p.adjust.method = "holm")
kruskal.test(Observed~body.site,data=alpha)
pairwise.wilcox.test(alpha$Observed,alpha$body.site,p.adjust.method = "holm")
shannonanova=aov(Shannon~body.site,data=alpha)
summary(shannonanova)
TukeyHSD(shannonanova)
```


















```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
