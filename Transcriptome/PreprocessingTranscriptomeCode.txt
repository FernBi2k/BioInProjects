# Create a new environment for transcriptomics

# activate that environment

# install the necessary packages
conda install -c bioconda hisat2
conda install -c bioconda samtools
conda install -c bioconda stringtie
conda install -c bioconda gffcompare

# Download the transcriptome data set and reference genome files (as .fna, .fasta, and .gff) from the link on Canvas. The transcriptome data set is 8 total samples, 2 replicates of planktonically grown P. aeruginosa and 2 replicates of biofilm P. aeruginosa each with a forward (pass 1) and reverse (pass 2) read. The .fna, .fasta, and .gff files should be directly in your folder for transcriptome work. The reads will be in a folder called fastq in your transcriptome folder.

# What is this code doing?
gunzip fastq/*.gz
####It decompresses the files that are compressed. For us, it is the files with the gz in the file name inside the fastq folder 

# Prepare the genome file
hisat2-build <path to genome file FNA> paeru

# Align reads to genome and assemble the transcripts #you will need to do these commands for every pair of reads (there are 4 in the tutorial). As an example, this is the command I ran for the plank01 sample.

1) hisat2 -q -x paeru -1 fastq/plank01_F.fastq -2 fastq/plank01_R.fastq -S plank01.sam
###1600000 reads; of these:
  1600000 (100.00%) were paired; of these:
    1504461 (94.03%) aligned concordantly 0 times
    92079 (5.75%) aligned concordantly exactly 1 time
    3460 (0.22%) aligned concordantly >1 times
    ----
    1504461 pairs aligned concordantly 0 times; of these:
      1253866 (83.34%) aligned discordantly 1 time
    ----
    250595 pairs aligned 0 times concordantly or discordantly; of these:
      501190 mates make up the pairs; of these:
        86635 (17.29%) aligned 0 times
        371477 (74.12%) aligned exactly 1 time
        43078 (8.60%) aligned >1 times
###97.29% overall alignment rate

2) hisat2 -q -x paeru -1 fastq/plank02_F.fastq -2 fastq/plank02_R.fastq -S plank02.sam
###1600000 reads; of these:
  1600000 (100.00%) were paired; of these:
    1500733 (93.80%) aligned concordantly 0 times
    95284 (5.96%) aligned concordantly exactly 1 time
    3983 (0.25%) aligned concordantly >1 times
    ----
    1500733 pairs aligned concordantly 0 times; of these:
      1235478 (82.32%) aligned discordantly 1 time
    ----
    265255 pairs aligned 0 times concordantly or discordantly; of these:
      530510 mates make up the pairs; of these:
        87380 (16.47%) aligned 0 times
        389220 (73.37%) aligned exactly 1 time
        53910 (10.16%) aligned >1 times
###97.27% overall alignment rate

3) hisat2 -q -x paeru -1 fastq/biofilm01_F.fastq -2 fastq/biofilm01_R.fastq -S biofilm01.sam
###1600000 reads; of these:
  1600000 (100.00%) were paired; of these:
    1507252 (94.20%) aligned concordantly 0 times
    91283 (5.71%) aligned concordantly exactly 1 time
    1465 (0.09%) aligned concordantly >1 times
    ----
    1507252 pairs aligned concordantly 0 times; of these:
      1251141 (83.01%) aligned discordantly 1 time
    ----
    256111 pairs aligned 0 times concordantly or discordantly; of these:
      512222 mates make up the pairs; of these:
        114859 (22.42%) aligned 0 times
        375356 (73.28%) aligned exactly 1 time
        22007 (4.30%) aligned >1 times
###96.41% overall alignment rate

4) hisat2 -q -x paeru -1 fastq/biofilm02_F.fastq -2 fastq/biofilm02_R.fastq -S biofilm02.sam
###1600000 reads; of these:
  1600000 (100.00%) were paired; of these:
    1517553 (94.85%) aligned concordantly 0 times
    81716 (5.11%) aligned concordantly exactly 1 time
    731 (0.05%) aligned concordantly >1 times
    ----
    1517553 pairs aligned concordantly 0 times; of these:
      1240840 (81.77%) aligned discordantly 1 time
    ----
    276713 pairs aligned 0 times concordantly or discordantly; of these:
      553426 mates make up the pairs; of these:
        137290 (24.81%) aligned 0 times
        393269 (71.06%) aligned exactly 1 time
        22867 (4.13%) aligned >1 times
###95.71% overall alignment rate

# Convert the .sam file to a .bam file. As an example, this is the command I ran for the plank01sample. This .sam file is also large, so you can delete it once youâ€™ve created the .bam file.

samtools view -bS plank01.sam > plank01.bam
samtools view -bS plank02.sam > plank02.bam
samtools view -bS biofilm01.sam > biofilm01.bam
samtools view -bS biofilm02.sam > biofilm02.bam

# Convert the .bam to a sorted .bam. This compresses the file and sorts the variants for easier discovery. As an example, this is the command I ran for the plank01 sample. 

samtools sort plank01.bam -o plank01.sorted.bam
samtools sort plank02.bam -o plank02.sorted.bam
samtools sort biofilm01.bam -o biofilm01.sorted.bam
samtools sort biofilm02.bam -o biofilm02.sorted.bam

# Reconstruct transcripts for each sample. As an example, this is the command I ran for the plank01 sample. 

stringtie plank01.sorted.bam -G paeruginosa.gff -o stringtie/plank01.transcripts.gtf
stringtie plank02.sorted.bam -G paeruginosa.gff -o stringtie/plank02.transcripts.gtf
stringtie biofilm01.sorted.bam -G paeruginosa.gff -o stringtie/biofilm01.transcripts.gtf
stringtie biofilm02.sorted.bam -G paeruginosa.gff -o stringtie/biofilm02.transcripts.gtf

# Create a file with the names of the files. As an example, this is the command I ran for the plank01 sample, followed by the plank02 sample.  Remember, file 1 gets >. Files 2-4 >>

echo stringtie/plank01.transcripts.gtf > assemblies.txt
echo stringtie/plank02.transcripts.gtf >> assemblies.txt
echo stringtie/biofilm01.transcripts.gtf >> assemblies.txt
echo stringtie/biofilm02.transcripts.gtf >> assemblies.txt

# Verify that assemblies.txt contains all file names #remember the command that lets you view the first contents of a file

# Merge the transcripts
stringtie --merge -G paeruginosa.gff -o stringtie_merged.gtf assemblies.txt

# Count the number of lines in the merged file
cat stringtie_merged.gtf | grep -v "^#" | awk '$3=="transcript" {print}' | wc -l
###5737 lines

# Compare assembled transcripts to known transcripts
gffcompare -r paeruginosa.gff -G -o merged stringtie_merged.gtf
### 5678 reference transcripts loaded.
  5737 query transfrags loaded.

# View success of comparison
  cat merged.stats
### Total union super-loci across all input datasets: 4773
5737 out of 5737 consensus transcripts written in merged.annotated.gtf (0 discarded as redundant)

# Estimate abundance and create Ballgown folder (for use in visualization). You will need to do this for each file. Here is the specific command I used for the plank01 file

stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/plank01/plank01.gtf plank01.sorted.bam

stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/plank02/plank02.gtf plank02.sorted.bam
stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/biofilm01/biofilm01.gtf biofilm01.sorted.bam
stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/biofilm02/biofilm02.gtf biofilm02.sorted.bam






